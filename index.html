<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Default theme */
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #fff;
            --text-secondary: #888;
            --text-tertiary: #aaa;
            --accent-start: #667eea;
            --accent-end: #764ba2;
            --stat-color: #667eea;
            --month-bg: rgba(0, 0, 0, 0.2);
            --day-cell-bg: rgba(255, 255, 255, 0.08);
            --day-cell-hover: rgba(255, 255, 255, 0.15);
            --input-bg: rgba(255, 255, 255, 0.1);
            --input-focus: rgba(255, 255, 255, 0.15);
            --delete-start: #f093fb;
            --delete-end: #f5576c;
            --archive-start: #ffa751;
            --archive-end: #ffe259;
        }

        /* Telegram theme integration */
        body.telegram-theme {
            --bg-gradient-start: var(--tg-theme-bg-color, #1a1a2e);
            --bg-gradient-end: var(--tg-theme-bg-color, #16213e);
            --card-bg: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.05));
            --text-primary: var(--tg-theme-text-color, #fff);
            --text-secondary: var(--tg-theme-hint-color, #888);
            --text-tertiary: var(--tg-theme-hint-color, #aaa);
            --accent-start: var(--tg-theme-button-color, #667eea);
            --accent-end: var(--tg-theme-button-color, #764ba2);
            --stat-color: var(--tg-theme-button-color, #667eea);
        }

        [data-theme="dark"] {
            --bg-gradient-start: #000000;
            --bg-gradient-end: #0a0a0a;
            --card-bg: rgba(255, 255, 255, 0.03);
            --card-border: rgba(255, 255, 255, 0.08);
            --text-primary: #fff;
            --text-secondary: #666;
            --text-tertiary: #999;
            --accent-start: #ffffff;
            --accent-end: #cccccc;
            --stat-color: #ffffff;
            --month-bg: rgba(255, 255, 255, 0.05);
            --day-cell-bg: rgba(255, 255, 255, 0.05);
            --day-cell-hover: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(255, 255, 255, 0.08);
            --input-focus: rgba(255, 255, 255, 0.12);
            --delete-start: #ff3333;
            --delete-end: #cc0000;
            --archive-start: #ffaa00;
            --archive-end: #ff8800;
        }

        [data-theme="bw"] {
            --bg-gradient-start: #1a1a1a;
            --bg-gradient-end: #0d0d0d;
            --card-bg: rgba(255, 255, 255, 0.04);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #808080;
            --text-tertiary: #a0a0a0;
            --accent-start: #ffffff;
            --accent-end: #e0e0e0;
            --stat-color: #ffffff;
            --month-bg: rgba(255, 255, 255, 0.06);
            --day-cell-bg: rgba(255, 255, 255, 0.06);
            --day-cell-hover: rgba(255, 255, 255, 0.12);
            --input-bg: rgba(255, 255, 255, 0.08);
            --input-focus: rgba(255, 255, 255, 0.12);
            --delete-start: #ffffff;
            --delete-end: #cccccc;
            --archive-start: #bbbbbb;
            --archive-end: #999999;
        }

        [data-theme="ocean"] {
            --bg-gradient-start: #0f2027;
            --bg-gradient-end: #203a43;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #fff;
            --text-secondary: #7aa8b8;
            --text-tertiary: #a0c4d0;
            --accent-start: #2c7a9b;
            --accent-end: #1f5e7a;
            --stat-color: #4da8da;
            --month-bg: rgba(0, 0, 0, 0.3);
            --day-cell-bg: rgba(45, 120, 155, 0.2);
            --day-cell-hover: rgba(45, 120, 155, 0.35);
            --input-bg: rgba(255, 255, 255, 0.08);
            --input-focus: rgba(255, 255, 255, 0.12);
            --delete-start: #e63946;
            --delete-end: #a4161a;
            --archive-start: #f4a261;
            --archive-end: #e76f51;
        }

        [data-theme="forest"] {
            --bg-gradient-start: #1a2f1a;
            --bg-gradient-end: #0d1f0d;
            --card-bg: rgba(255, 255, 255, 0.04);
            --card-border: rgba(144, 238, 144, 0.15);
            --text-primary: #e8f5e9;
            --text-secondary: #81c784;
            --text-tertiary: #a5d6a7;
            --accent-start: #4caf50;
            --accent-end: #2e7d32;
            --stat-color: #66bb6a;
            --month-bg: rgba(0, 0, 0, 0.25);
            --day-cell-bg: rgba(76, 175, 80, 0.15);
            --day-cell-hover: rgba(76, 175, 80, 0.25);
            --input-bg: rgba(255, 255, 255, 0.08);
            --input-focus: rgba(255, 255, 255, 0.12);
            --delete-start: #ef5350;
            --delete-end: #c62828;
            --archive-start: #ffb74d;
            --archive-end: #ffa726;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 10px;
            margin: 0;
            overflow-x: hidden;
            /* Telegram specific */
            -webkit-user-select: none;
            user-select: none;
        }

        /* Allow text selection only in input fields */
        input, .subtitle {
            -webkit-user-select: text;
            user-select: text;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-end) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            font-size: 1.2em;
            color: var(--text-secondary);
            font-style: italic;
            margin-bottom: 30px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: color 0.3s;
            position: relative;
            padding: 8px 40px;
        }

        .subtitle:hover {
            color: var(--text-tertiary);
        }

        .subtitle::after {
            content: '‚úèÔ∏è';
            font-size: 0.7em;
            opacity: 0;
            transition: opacity 0.3s;
            margin-left: 10px;
        }

        .subtitle:hover::after {
            opacity: 0.6;
        }

        .subtitle-input {
            text-align: center;
            font-size: 1.2em;
            color: var(--text-primary);
            font-style: italic;
            letter-spacing: 2px;
            background: var(--input-bg);
            border: 2px solid var(--accent-start);
            border-radius: 8px;
            padding: 8px 20px;
            margin: 0 auto 30px auto;
            display: block;
            max-width: 600px;
            width: 90%;
        }

        .subtitle-input:focus {
            outline: none;
            background: var(--input-focus);
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .language-switcher {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 5px;
        }

        .lang-btn {
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            background: var(--day-cell-bg);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
            font-weight: 600;
        }

        .lang-btn:hover {
            background: var(--day-cell-hover);
            color: var(--text-primary);
        }

        .lang-btn.active {
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-end) 100%);
            color: var(--text-primary);
        }

        .habit-section {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 18px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
        }

        .habit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 12px;
            cursor: pointer;
            user-select: none;
        }

        .habit-header:hover .habit-name {
            color: #667eea;
        }

        .habit-name {
            font-size: 1.3em;
            font-weight: 600;
            transition: color 0.2s;
            flex: 0 1 auto;
            min-width: 0;
        }

        .habit-name::before {
            content: '‚ñº ';
            font-size: 0.65em;
            margin-right: 6px;
            transition: transform 0.3s;
            display: inline-block;
        }

        .habit-section.collapsed .habit-name::before {
            transform: rotate(-90deg);
        }

        .habit-buttons {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .mini-calendar {
            display: flex;
            gap: 6px;
            align-items: center;
            margin: 0 12px;
        }

        .mini-day {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--day-cell-bg);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            position: relative;
        }

        .mini-day:hover {
            background: var(--day-cell-hover);
            transform: scale(1.05);
        }

        .mini-day.completed {
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-end) 100%);
        }

        .mini-day.today {
            border: 2px solid #ffd700;
        }

        .mini-day-number {
            font-weight: 600;
            font-size: 1.1em;
        }

        .mini-day-label {
            font-size: 0.7em;
            opacity: 0.7;
            margin-top: -2px;
        }

        .calendar-container {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 10000px;
            opacity: 1;
        }

        .habit-section.collapsed .calendar-container {
            max-height: 0;
            opacity: 0;
        }

        .habit-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--stat-color);
        }

        .calendar {
            display: grid;
            gap: 12px;
            margin-top: 15px;
        }

        .month-section {
            background: var(--month-bg);
            border-radius: 8px;
            padding: 12px;
        }

        .month-name {
            font-size: 1em;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--accent-start);
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .month-name:hover {
            color: var(--accent-end);
        }

        .month-name::before {
            content: '‚ñº ';
            font-size: 0.8em;
            margin-right: 5px;
            transition: transform 0.3s;
            display: inline-block;
        }

        .month-section.collapsed .month-name::before {
            transform: rotate(-90deg);
        }

        .month-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 5000px;
            opacity: 1;
        }

        .month-section.collapsed .month-content {
            max-height: 0;
            opacity: 0;
        }

        .week-grid {
            display: grid;
            grid-template-columns: 50px repeat(7, 1fr);
            gap: 3px;
            margin-bottom: 3px;
        }

        .day-label {
            font-size: 0.75em;
            color: var(--text-secondary);
            padding: 3px;
            text-align: center;
        }

        .day-cell {
            aspect-ratio: 1;
            background: var(--day-cell-bg);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .day-cell:hover {
            background: var(--day-cell-hover);
            transform: scale(1.05);
        }

        .day-cell.completed {
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-end) 100%);
        }

        .day-cell.today {
            border: 2px solid #ffd700;
        }

        .add-habit {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .add-note {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .add-note input {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 1em;
            transition: all 0.3s;
        }

        .add-note input:focus {
            outline: none;
            background: var(--input-focus);
            box-shadow: 0 0 0 2px var(--accent-start);
        }

        .note-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .note-card:hover {
            transform: translateY(-2px);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .note-title {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--text-primary);
        }

        .note-date {
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .note-preview {
            color: var(--text-secondary);
            font-size: 0.95em;
            line-height: 1.5;
            margin-bottom: 12px;
            max-height: 100px;
            overflow: hidden;
        }

        .note-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .note-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .note-modal.active {
            display: flex;
        }

        .note-modal-content {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .note-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .note-modal-title {
            flex: 1;
            font-size: 1.5em;
            font-weight: 600;
            padding: 8px 12px;
            border: 2px solid transparent;
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            margin-right: 12px;
        }

        .note-modal-title:focus {
            outline: none;
            border-color: var(--accent-start);
        }

        .note-close-btn {
            background: var(--delete-start);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .note-textarea {
            width: 100%;
            min-height: 300px;
            padding: 15px;
            border: 2px solid var(--card-border);
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 1em;
            font-family: inherit;
            line-height: 1.6;
            resize: vertical;
        }

        .note-textarea:focus {
            outline: none;
            border-color: var(--accent-start);
        }

        .text-preview {
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .text-preview h3 {
            color: var(--accent-start);
        }

        .text-preview li {
            list-style: none;
        }

        .note-section {
            position: relative;
        }

        .note-toolbar {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 8px 12px;
            background: var(--input-bg);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: var(--accent-start);
            color: white;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--input-bg);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .checklist-item:hover {
            background: var(--input-focus);
        }

        .checklist-checkbox {
            width: 20px;
            height: 20px;
            min-width: 20px;
            cursor: pointer;
            border: 2px solid var(--accent-start);
            border-radius: 4px;
            background: transparent;
            position: relative;
        }

        .checklist-checkbox.checked {
            background: var(--accent-start);
        }

        .checklist-checkbox.checked::after {
            content: '‚úì';
            position: absolute;
            color: white;
            font-size: 14px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .checklist-text {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1em;
            padding: 4px;
            border-bottom: 1px solid transparent;
        }

        .checklist-text:focus {
            outline: none;
            border-bottom-color: var(--accent-start);
        }

        .checklist-text.completed {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .checklist-delete {
            color: var(--delete-start);
            cursor: pointer;
            font-size: 1.2em;
            padding: 4px 8px;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .checklist-delete:hover {
            opacity: 1;
        }

        .checklist-section {
            border-top: 1px solid var(--card-border);
            padding-top: 20px;
        }

        .archive-toggle {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }

        .archive-btn {
            background: var(--input-bg);
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .archive-btn:hover {
            background: var(--input-focus);
        }

        .archive-btn.active {
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-end) 100%);
            border-color: var(--accent-start);
        }

        .archive-sub-btn {
            background: var(--input-bg);
            padding: 8px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            font-size: 0.9em;
            color: var(--text-secondary);
        }

        .archive-sub-btn:hover {
            background: var(--input-focus);
            color: var(--text-primary);
        }

        .archive-sub-btn.active {
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-end) 100%);
            border-color: var(--accent-start);
            color: white;
        }

        .add-habit input {
            flex: 1;
            min-width: 200px;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 1em;
        }

        .add-habit input::placeholder {
            color: var(--text-secondary);
        }

        .add-habit input:focus {
            outline: none;
            background: var(--input-focus);
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: linear-gradient(135deg, var(--accent-start) 0%, var(--accent-end) 100%);
            color: white;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            white-space: nowrap;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        .delete-btn {
            background: linear-gradient(135deg, var(--delete-start) 0%, var(--delete-end) 100%);
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .archive-habit-btn {
            background: linear-gradient(135deg, var(--archive-start) 0%, var(--archive-end) 100%);
            padding: 8px 16px;
            font-size: 0.85em;
        }

        .month-download-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 6px 14px;
            font-size: 0.8em;
            margin-top: 10px;
            width: 100%;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state h2 {
            margin-bottom: 10px;
            color: var(--text-tertiary);
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }

            .container {
                padding: 0;
            }

            .week-grid {
                grid-template-columns: 40px repeat(7, 1fr);
                gap: 2px;
            }

            .day-label {
                font-size: 0.7em;
            }

            h1 {
                font-size: 1.8em;
                margin-bottom: 5px;
            }

            .subtitle {
                font-size: 1em;
                margin-bottom: 20px;
            }

            .habit-name {
                font-size: 1.1em;
            }

            .habit-section {
                padding: 15px;
                margin-bottom: 15px;
            }

            .language-switcher {
                position: static;
                margin: 0 auto 10px auto;
            }

            .theme-selector {
                position: static;
                margin: 0 auto 20px auto;
                align-items: center;
                justify-content: center;
            }

            .theme-buttons {
                justify-content: center;
            }

            .add-habit {
                flex-direction: column;
            }

            .add-habit input {
                width: 100%;
                min-width: auto;
            }

            .add-habit button {
                width: 100%;
            }

            .habit-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .habit-stats {
                width: 100%;
                justify-content: space-around;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="mainTitle">–¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫</h1>
        <div class="subtitle" id="subtitle" onclick="editSubtitle()">Just Do It</div>
        
        <div class="language-switcher">
            <button class="lang-btn active" onclick="setLanguage('ru')">RU</button>
            <button class="lang-btn" onclick="setLanguage('en')">EN</button>
        </div>

        <div class="archive-toggle">
            <button class="archive-btn active" id="activeBtn" onclick="showActive()">üìã –ê–∫—Ç–∏–≤–Ω—ã–µ</button>
            <button class="archive-btn" id="archiveBtn" onclick="showArchived()" style="margin-left: 10px;">üì¶ –ê—Ä—Ö–∏–≤</button>
            <button class="archive-btn" id="notesBtn" onclick="showNotes()" style="margin-left: 10px;">üìù –ó–∞–º–µ—Ç–∫–∏</button>
        </div>

        <div class="add-habit" id="addHabitSection">
            <input type="text" id="habitInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏..." maxlength="50">
            <button id="addBtn" onclick="addHabit()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É</button>
        </div>

        <div class="add-note" id="addNoteSection" style="display: none;">
            <input type="text" id="noteTitleInput" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏..." maxlength="100">
            <button id="addNoteBtn" onclick="addNote()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
        </div>

        <div id="habitsContainer"></div>
        <div id="notesContainer" style="display: none;"></div>
        <div id="archiveContainer" style="display: none;"></div>
    </div>

    <script>
        const MONTHS = ['–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä', '–ê–ø—Ä', '–ú–∞–π', '–ò—é–Ω', '–ò—é–ª', '–ê–≤–≥', '–°–µ–Ω', '–û–∫—Ç', '–ù–æ—è', '–î–µ–∫'];
        const DAYS = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
        
        const MONTHS_EN = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const DAYS_EN = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        
        const translations = {
            ru: {
                title: '–¢—Ä–µ–∫–µ—Ä –ø—Ä–∏–≤—ã—á–µ–∫',
                defaultSubtitle: 'Just Do It',
                themeLabel: '–¢–µ–º–∞',
                active: '–ê–∫—Ç–∏–≤–Ω—ã–µ',
                archive: '–ê—Ä—Ö–∏–≤',
                notes: '–ó–∞–º–µ—Ç–∫–∏',
                addPlaceholder: '–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø—Ä–∏–≤—ã—á–∫–∏...',
                addButton: '‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–≤—ã—á–∫—É',
                thisMonth: '–í –º–µ—Å—è—Ü–µ',
                total: '–í—Å–µ–≥–æ',
                downloadMonth: 'üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è',
                toArchive: 'üì¶ –í –∞—Ä—Ö–∏–≤',
                restore: 'üì§ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å',
                delete: 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å',
                deleteConfirm: '–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–∏–≤—ã—á–∫—É?',
                noActiveHabits: '–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫',
                noActiveHabitsDesc: '–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—ã—á–∫—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ!',
                emptyArchive: '–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç',
                emptyArchiveDesc: '–ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏',
                week: '–ù',
                // Notes translations
                noteTitlePlaceholder: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏...',
                addNoteButton: '‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É',
                noNotes: '–ó–∞–º–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç',
                noNotesDesc: '–î–æ–±–∞–≤—å—Ç–µ —Å–≤–æ—é –ø–µ—Ä–≤—É—é –∑–∞–º–µ—Ç–∫—É!',
                untitledNote: '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
                deleteNote: 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å',
                deleteNoteConfirm: '–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?',
                addTextSection: 'üìù –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç',
                addChecklistSection: '‚òëÔ∏è –î–æ–±–∞–≤–∏—Ç—å —á–µ–∫-–ª–∏—Å—Ç',
                deleteSection: '‚úï –£–¥–∞–ª–∏—Ç—å',
                textPlaceholder: '–ü–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç... –í—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è'
            },
            en: {
                title: 'Habit Tracker',
                defaultSubtitle: 'Just Do It',
                themeLabel: 'Theme',
                active: 'Active',
                archive: 'Archive',
                notes: 'Notes',
                addPlaceholder: 'New habit name...',
                addButton: '‚ûï Add Habit',
                thisMonth: 'This Month',
                total: 'Total',
                downloadMonth: 'üì§ Share',
                toArchive: 'üì¶ Archive',
                restore: 'üì§ Restore',
                delete: 'üóëÔ∏è Delete',
                deleteConfirm: 'Delete this habit?',
                noActiveHabits: 'You have no active habits yet',
                noActiveHabitsDesc: 'Add your first habit to start tracking!',
                emptyArchive: 'Archive is empty',
                emptyArchiveDesc: 'Archived habits will be displayed here',
                week: 'W',
                // Notes translations
                noteTitlePlaceholder: 'Note title...',
                addNoteButton: '‚ûï Add Note',
                noNotes: 'No notes yet',
                noNotesDesc: 'Add your first note!',
                untitledNote: 'Untitled',
                deleteNote: 'üóëÔ∏è Delete',
                deleteNoteConfirm: 'Delete this note?',
                addTextSection: 'üìù Add Text',
                addChecklistSection: '‚òëÔ∏è Add Checklist',
                deleteSection: '‚úï Delete',
                textPlaceholder: 'Start writing... Select text and press buttons to format'
            }
        };
        
        let habits = [];
        let notes = [];
        let currentView = 'active'; // 'active', 'archived', or 'notes'
        let archiveSubView = 'all'; // 'habits', 'notes', or 'all' - for archive sub-tabs
        let currentLang = 'ru';
        let customSubtitle = '';
        let currentTheme = 'default';
        let currentNoteId = null;

        async function loadHabits() {
            try {
                const habitsData = localStorage.getItem('habits');
                if (habitsData) {
                    habits = JSON.parse(habitsData);
                }
            } catch (error) {
                console.log('No saved habits found');
                habits = [];
            }

            // Load notes
            try {
                const notesData = localStorage.getItem('notes');
                if (notesData) {
                    notes = JSON.parse(notesData);
                }
            } catch (error) {
                console.log('No saved notes found');
                notes = [];
            }
            
            try {
                const lang = localStorage.getItem('language');
                if (lang) {
                    currentLang = lang;
                }
            } catch (error) {
                currentLang = 'ru';
            }
            
            try {
                const subtitle = localStorage.getItem('customSubtitle');
                if (subtitle) {
                    customSubtitle = subtitle;
                }
            } catch (error) {
                customSubtitle = '';
            }
            
            try {
                const theme = localStorage.getItem('theme');
                if (theme) {
                    currentTheme = theme;
                    document.documentElement.setAttribute('data-theme', currentTheme);
                }
            } catch (error) {
                currentTheme = 'default';
            }
            
            updateLanguageUI();
            updateThemeUI();
            renderHabits();
        }

        async function saveSubtitle(text) {
            customSubtitle = text;
            try {
                localStorage.setItem('customSubtitle', text);
            } catch (error) {
                console.error('Error saving subtitle:', error);
            }
        }

        async function saveHabits() {
            try {
                localStorage.setItem('habits', JSON.stringify(habits));
            } catch (error) {
                console.error('Error saving habits:', error);
            }
        }

        async function setLanguage(lang) {
            currentLang = lang;
            try {
                localStorage.setItem('language', lang);
            } catch (error) {
                console.error('Error saving language:', error);
            }
            updateLanguageUI();
            renderHabits();
        }

        async function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            try {
                localStorage.setItem('theme', theme);
            } catch (error) {
                console.error('Error saving theme:', error);
            }
            updateThemeUI();
        }

        function updateThemeUI() {
            const themeButtons = document.querySelectorAll('.theme-btn');
            themeButtons.forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-theme') === currentTheme);
            });
        }

        function updateLanguageUI() {
            const t = translations[currentLang];
            
            document.getElementById('mainTitle').textContent = t.title;
            
            const subtitleElement = document.getElementById('subtitle');
            const displayText = customSubtitle || t.defaultSubtitle;
            subtitleElement.textContent = displayText;
            
            document.getElementById('activeBtn').textContent = 'üìã ' + t.active;
            document.getElementById('archiveBtn').textContent = 'üì¶ ' + t.archive;
            document.getElementById('notesBtn').textContent = 'üìù ' + t.notes;
            document.getElementById('habitInput').placeholder = t.addPlaceholder;
            document.getElementById('addBtn').textContent = t.addButton;
            
            // Notes translations
            document.getElementById('noteTitleInput').placeholder = t.noteTitlePlaceholder;
            document.getElementById('addNoteBtn').textContent = t.addNoteButton;
            
            // Note modal buttons
            const addTextBtn = document.getElementById('addTextSectionBtn');
            const addChecklistBtn = document.getElementById('addChecklistSectionBtn');
            if (addTextBtn) addTextBtn.textContent = t.addTextSection;
            if (addChecklistBtn) addChecklistBtn.textContent = t.addChecklistSection;
            
            const langButtons = document.querySelectorAll('.lang-btn');
            langButtons[0].classList.toggle('active', currentLang === 'ru');
            langButtons[1].classList.toggle('active', currentLang === 'en');
            
            // Re-render current view to update translations
            if (currentView === 'active') {
                renderHabits();
            } else if (currentView === 'archived') {
                renderArchived();
            } else if (currentView === 'notes') {
                renderNotes();
            }
            
            // Update note modal if it's open
            if (currentNoteId) {
                renderNoteSections();
            }
        }

        function editSubtitle() {
            const subtitleElement = document.getElementById('subtitle');
            const currentText = subtitleElement.textContent;
            
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentText;
            input.className = 'subtitle-input';
            input.maxLength = 100;
            
            subtitleElement.replaceWith(input);
            input.focus();
            input.select();
            
            function saveAndRestore() {
                const newText = input.value.trim();
                const newSubtitle = document.createElement('div');
                newSubtitle.id = 'subtitle';
                newSubtitle.className = 'subtitle';
                newSubtitle.textContent = newText || translations[currentLang].defaultSubtitle;
                newSubtitle.onclick = editSubtitle;
                
                input.replaceWith(newSubtitle);
                saveSubtitle(newText);
            }
            
            input.addEventListener('blur', saveAndRestore);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveAndRestore();
                }
            });
        }

        function addHabit() {
            const input = document.getElementById('habitInput');
            const name = input.value.trim();
            
            if (!name) return;
            
            const habit = {
                id: Date.now(),
                name: name,
                completed: [],
                collapsed: false,
                archived: false
            };
            
            habits.push(habit);
            input.value = '';
            saveHabits();
            renderHabits();
        }

        function deleteHabit(id, event) {
            event.stopPropagation();
            const t = translations[currentLang];
            if (confirm(t.deleteConfirm)) {
                habits = habits.filter(h => h.id !== id);
                saveHabits();
                renderHabits();
            }
        }

        function archiveHabit(id, event) {
            event.stopPropagation();
            const habit = habits.find(h => h.id === id);
            if (!habit) return;
            
            habit.archived = !habit.archived;
            saveHabits();
            renderHabits();
        }

        function restoreHabit(id) {
            const habit = habits.find(h => h.id === id);
            if (!habit) return;
            
            habit.archived = false;
            saveHabits();
            renderArchived();
        }

        function showActive() {
            currentView = 'active';
            updateViewButtons();
            renderHabits();
            document.getElementById('habitsContainer').style.display = 'block';
            document.getElementById('notesContainer').style.display = 'none';
            document.getElementById('archiveContainer').style.display = 'none';
            document.getElementById('addHabitSection').style.display = 'flex';
            document.getElementById('addNoteSection').style.display = 'none';
        }

        function showArchived() {
            currentView = 'archived';
            archiveSubView = 'all'; // Reset to 'all' when entering archive
            updateViewButtons();
            renderArchived();
            document.getElementById('habitsContainer').style.display = 'none';
            document.getElementById('notesContainer').style.display = 'none';
            document.getElementById('archiveContainer').style.display = 'block';
            document.getElementById('addHabitSection').style.display = 'none';
            document.getElementById('addNoteSection').style.display = 'none';
        }

        function showArchiveHabits() {
            archiveSubView = 'habits';
            updateArchiveButtons();
            renderArchived();
        }

        function showArchiveNotes() {
            archiveSubView = 'notes';
            updateArchiveButtons();
            renderArchived();
        }

        function showArchiveAll() {
            archiveSubView = 'all';
            updateArchiveButtons();
            renderArchived();
        }

        function updateArchiveButtons() {
            const buttons = document.querySelectorAll('.archive-sub-btn');
            if (buttons.length > 0) {
                buttons[0].classList.toggle('active', archiveSubView === 'habits');
                buttons[1].classList.toggle('active', archiveSubView === 'notes');
                buttons[2].classList.toggle('active', archiveSubView === 'all');
            }
        }

        function renderArchived() {
            const archiveContainer = document.getElementById('archiveContainer');
            if (!archiveContainer) return;

            const archivedHabits = habits.filter(h => h.archived);
            const archivedNotes = notes.filter(n => n.archived);

            // Add sub-navigation tabs
            let html = `
                <div class="archive-sub-nav" style="display: flex; justify-content: center; gap: 10px; margin-bottom: 25px;">
                    <button class="archive-sub-btn ${archiveSubView === 'habits' ? 'active' : ''}" onclick="showArchiveHabits()">üìã –ü—Ä–∏–≤—ã—á–∫–∏ (${archivedHabits.length})</button>
                    <button class="archive-sub-btn ${archiveSubView === 'notes' ? 'active' : ''}" onclick="showArchiveNotes()">üìù –ó–∞–º–µ—Ç–∫–∏ (${archivedNotes.length})</button>
                    <button class="archive-sub-btn ${archiveSubView === 'all' ? 'active' : ''}" onclick="showArchiveAll()">üì¶ –í—Å–µ (${archivedHabits.length + archivedNotes.length})</button>
                </div>
            `;

            // Check if archive is empty
            const showHabits = archiveSubView === 'all' || archiveSubView === 'habits';
            const showNotes = archiveSubView === 'all' || archiveSubView === 'notes';
            
            const hasContent = (showHabits && archivedHabits.length > 0) || (showNotes && archivedNotes.length > 0);

            if (!hasContent) {
                const emptyMessage = archiveSubView === 'habits' 
                    ? '–ù–µ—Ç –∞—Ä—Ö–∏–≤–Ω—ã—Ö –ø—Ä–∏–≤—ã—á–µ–∫'
                    : archiveSubView === 'notes'
                    ? '–ù–µ—Ç –∞—Ä—Ö–∏–≤–Ω—ã—Ö –∑–∞–º–µ—Ç–æ–∫'
                    : '–ê—Ä—Ö–∏–≤ –ø—É—Å—Ç';
                
                html += `
                    <div class="empty-state">
                        <h2>${emptyMessage}</h2>
                        <p>–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                    </div>
                `;
                archiveContainer.innerHTML = html;
                return;
            }

            // Render archived habits
            if (showHabits && archivedHabits.length > 0) {
                if (archiveSubView === 'all') {
                    html += '<h2 style="margin: 20px 0 15px 0; color: var(--text-secondary);">üìã –ü—Ä–∏–≤—ã—á–∫–∏</h2>';
                }
                archivedHabits.forEach(habit => {
                    html += `
                        <div class="habit" style="margin-bottom: 20px;">
                            <div class="habit-header">
                                <div class="habit-name-container">
                                    <span class="habit-name">${habit.name}</span>
                                </div>
                                <div class="habit-buttons">
                                    <button class="restore-btn" onclick="restoreHabit(${habit.id})">üì§ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                                    <button class="delete-btn" onclick="deleteHabit(${habit.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            // Render archived notes
            if (showNotes && archivedNotes.length > 0) {
                if (archiveSubView === 'all') {
                    html += '<h2 style="margin: 30px 0 15px 0; color: var(--text-secondary);">üìù –ó–∞–º–µ—Ç–∫–∏</h2>';
                }
                archivedNotes.forEach(note => {
                    // Ensure sections exist
                    if (!note.sections) {
                        note.sections = [];
                    }

                    // Generate preview
                    let preview = '';
                    let checklistInfo = '';
                    
                    note.sections.forEach(section => {
                        if (section.type === 'text' && section.data && preview.length < 150) {
                            preview += section.data.substring(0, 150 - preview.length);
                        }
                    });

                    // Count checklists
                    const checklists = note.sections.filter(s => s.type === 'checklist');
                    if (checklists.length > 0) {
                        let totalItems = 0;
                        let completedItems = 0;
                        checklists.forEach(cl => {
                            totalItems += cl.data.length;
                            completedItems += cl.data.filter(i => i.completed).length;
                        });
                        if (totalItems > 0) {
                            checklistInfo = `<div style="color: var(--text-secondary); font-size: 0.9em; margin-top: 8px;">
                                 ‚òëÔ∏è –ß–µ–∫-–ª–∏—Å—Ç: ${completedItems}/${totalItems} –≤—ã–ø–æ–ª–Ω–µ–Ω–æ
                               </div>`;
                        }
                    }

                    const previewText = preview ? `<div class="note-preview">${preview}${preview.length >= 150 ? '...' : ''}</div>` : '';
                    
                    html += `
                        <div class="note-card" onclick="openNoteModal(${note.id})">
                            <div class="note-header">
                                <div class="note-title">${note.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</div>
                                <div class="note-date">${formatDate(note.updatedAt)}</div>
                            </div>
                            ${previewText}
                            ${checklistInfo}
                            <div class="note-actions">
                                <button class="restore-btn" onclick="event.stopPropagation(); restoreNote(${note.id})">üì§ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                                <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${note.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                    `;
                });
            }

            archiveContainer.innerHTML = html;
        }

        function showNotes() {
            currentView = 'notes';
            updateViewButtons();
            renderNotes();
            document.getElementById('habitsContainer').style.display = 'none';
            document.getElementById('notesContainer').style.display = 'block';
            document.getElementById('archiveContainer').style.display = 'none';
            document.getElementById('addHabitSection').style.display = 'none';
            document.getElementById('addNoteSection').style.display = 'flex';
        }

        function updateViewButtons() {
            const buttons = document.querySelectorAll('.archive-btn');
            buttons[0].classList.toggle('active', currentView === 'active');
            buttons[1].classList.toggle('active', currentView === 'archived');
            buttons[2].classList.toggle('active', currentView === 'notes');
        }

        function toggleCollapse(habitId, event) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;
            
            habit.collapsed = !habit.collapsed;
            saveHabits();
            renderHabits();
        }

        function toggleDay(habitId, dateStr) {
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;
            
            const index = habit.completed.indexOf(dateStr);
            if (index > -1) {
                habit.completed.splice(index, 1);
            } else {
                habit.completed.push(dateStr);
            }
            
            saveHabits();
            renderHabits();
        }

        function generateMiniCalendar(habit) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const days = currentLang === 'ru' ? DAYS : DAYS_EN;
            
            let html = '<div class="mini-calendar">';
            
            // Show 10 days: 3 days back to 6 days ahead
            for (let i = -3; i <= 6; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const dateStr = getDateString(date);
                const dayNumber = date.getDate();
                const dayOfWeek = date.getDay();
                const dayLabel = days[dayOfWeek === 0 ? 6 : dayOfWeek - 1]; // Convert to Monday-first
                
                const isCompleted = habit.completed.includes(dateStr);
                const isToday = i === 0;
                
                html += `<div class="mini-day ${isCompleted ? 'completed' : ''} ${isToday ? 'today' : ''}" 
                             onclick="event.stopPropagation(); toggleDay(${habit.id}, '${dateStr}')">
                            <div class="mini-day-number">${dayNumber}</div>
                            <div class="mini-day-label">${dayLabel}</div>
                         </div>`;
            }
            
            html += '</div>';
            return html;
        }

        function getDateString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }

        function getFirstDayOfMonth(year, month) {
            // Get day of week: 0=Sunday, 1=Monday, ..., 6=Saturday
            let day = new Date(year, month, 1).getDay();
            // Convert to Monday-based: 0=Monday, 1=Tuesday, ..., 6=Sunday
            // Sunday (0) becomes 6, Monday (1) becomes 0, etc.
            return (day + 6) % 7;
        }

        function downloadHabitMonth(habitId, month, year, event) {
            event.stopPropagation();
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;
            
            generateCalendarImage([habit], month, year);
        }

        function generateCalendarImage(habitsToExport, month, year) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const months = currentLang === 'ru' ? MONTHS : MONTHS_EN;
            const days = currentLang === 'ru' ? DAYS : DAYS_EN;
            
            // Square format 1:1
            const size = 1080;
            canvas.width = size;
            canvas.height = size;
            
            const padding = 60;
            const contentWidth = size - (padding * 2);
            
            // Background gradient
            const bgGradient = ctx.createLinearGradient(0, 0, size, size);
            bgGradient.addColorStop(0, '#1a1a2e');
            bgGradient.addColorStop(1, '#16213e');
            ctx.fillStyle = bgGradient;
            ctx.fillRect(0, 0, size, size);
            
            // Calculate calendar dimensions first to center everything
            const cellSize = 70;
            const cellGap = 8;
            const daysInMonth = getDaysInMonth(year, month);
            const firstDay = getFirstDayOfMonth(year, month);
            const weeks = Math.ceil((daysInMonth + firstDay) / 7);
            
            const calendarHeight = (weeks * (cellSize + cellGap)) - cellGap;
            const totalContentHeight = 100 + 70 + 80 + 40 + calendarHeight + 60;
            
            let yOffset = (size - totalContentHeight) / 2;
            
            // Title
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 42px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`üìä ${translations[currentLang].title}`, size / 2, yOffset + 35);
            yOffset += 70;
            
            // Month and year
            ctx.font = 'bold 36px -apple-system, sans-serif';
            ctx.fillStyle = '#667eea';
            ctx.fillText(`${months[month]} ${year}`, size / 2, yOffset + 30);
            yOffset += 70;
            
            habitsToExport.forEach((habit, habitIndex) => {
                const stats = calculateStats(habit);
                
                // Habit name and stats on same line
                ctx.fillStyle = '#ffffff';
                ctx.font = 'bold 32px -apple-system, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(habit.name, padding, yOffset);
                
                ctx.font = '24px -apple-system, sans-serif';
                ctx.fillStyle = '#aaaaaa';
                ctx.textAlign = 'right';
                const statsText = `${stats.thisMonthCompleted} ${currentLang === 'ru' ? '–¥–Ω–µ–π' : 'days'}`;
                ctx.fillText(statsText, size - padding, yOffset);
                
                yOffset += 50;
                
                // Draw calendar grid
                const gridWidth = (cellSize * 7) + (cellGap * 6);
                const startX = (size - gridWidth) / 2;
                
                // Day labels
                ctx.font = 'bold 18px -apple-system, sans-serif';
                ctx.fillStyle = '#aaaaaa';
                ctx.textAlign = 'center';
                
                for (let d = 0; d < 7; d++) {
                    const x = startX + (d * (cellSize + cellGap)) + cellSize / 2;
                    ctx.fillText(days[d], x, yOffset + 20);
                }
                
                yOffset += 40;
                
                // Draw days
                let dayNum = 1;
                
                for (let week = 0; week < weeks; week++) {
                    for (let day = 0; day < 7; day++) {
                        if ((week === 0 && day < firstDay) || dayNum > daysInMonth) {
                            continue;
                        }
                        
                        const x = startX + (day * (cellSize + cellGap));
                        const y = yOffset + (week * (cellSize + cellGap));
                        
                        const date = new Date(year, month, dayNum);
                        const dateStr = getDateString(date);
                        const isCompleted = habit.completed.includes(dateStr);
                        
                        // Cell background with rounded corners
                        ctx.save();
                        const radius = 10;
                        ctx.beginPath();
                        ctx.moveTo(x + radius, y);
                        ctx.lineTo(x + cellSize - radius, y);
                        ctx.quadraticCurveTo(x + cellSize, y, x + cellSize, y + radius);
                        ctx.lineTo(x + cellSize, y + cellSize - radius);
                        ctx.quadraticCurveTo(x + cellSize, y + cellSize, x + cellSize - radius, y + cellSize);
                        ctx.lineTo(x + radius, y + cellSize);
                        ctx.quadraticCurveTo(x, y + cellSize, x, y + cellSize - radius);
                        ctx.lineTo(x, y + radius);
                        ctx.quadraticCurveTo(x, y, x + radius, y);
                        ctx.closePath();
                        
                        if (isCompleted) {
                            const gradient = ctx.createLinearGradient(x, y, x + cellSize, y + cellSize);
                            gradient.addColorStop(0, '#667eea');
                            gradient.addColorStop(1, '#764ba2');
                            ctx.fillStyle = gradient;
                        } else {
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.08)';
                        }
                        ctx.fill();
                        ctx.restore();
                        
                        // Day number
                        ctx.fillStyle = isCompleted ? '#ffffff' : '#888888';
                        ctx.font = 'bold 24px -apple-system, sans-serif';
                        ctx.textAlign = 'center';
                        ctx.fillText(dayNum, x + cellSize / 2, y + cellSize / 2 + 8);
                        
                        dayNum++;
                    }
                }
                
                yOffset += calendarHeight + 50;
            });
            
            // Footer
            ctx.fillStyle = '#666666';
            ctx.font = '20px -apple-system, sans-serif';
            ctx.textAlign = 'center';
            const subtitle = customSubtitle || translations[currentLang].defaultSubtitle;
            ctx.fillText(subtitle, size / 2, yOffset);
            
            // Share/Download image
            const habitName = habitsToExport[0]?.name || 'habit';
            const fileName = `${habitName.replace(/[^a-zA-Z–∞-—è–ê-–Ø0-9]/g, '-')}-${months[month]}-${year}.png`;
            
            canvas.toBlob(async (blob) => {
                if (!blob) return;
                
                // Check if we're in Telegram and Share API is available
                if (window.Telegram?.WebApp && navigator.share) {
                    try {
                        const file = new File([blob], fileName, { type: 'image/png' });
                        
                        await navigator.share({
                            files: [file],
                            title: habitName,
                            text: `${months[month]} ${year}`
                        });
                        
                        console.log('Image shared successfully');
                    } catch (err) {
                        // If sharing fails or is cancelled, show the image in a new window
                        if (err.name !== 'AbortError') {
                            const url = URL.createObjectURL(blob);
                            window.open(url, '_blank');
                            
                            window.Telegram.WebApp.showAlert(
                                currentLang === 'ru'
                                    ? '–ö–∞—Ä—Ç–∏–Ω–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ. –ù–∞–∂–º–∏—Ç–µ –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.'
                                    : 'Image opened in new window. Tap and hold to save.'
                            );
                        }
                    }
                } else {
                    // Regular browser download
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                    }, 100);
                }
            }, 'image/png', 0.95);
        }

        function toggleMonth(habitId, month, event) {
            event.stopPropagation();
            const habit = habits.find(h => h.id === habitId);
            if (!habit) return;
            
            if (!habit.collapsedMonths) {
                habit.collapsedMonths = [];
            }
            
            const index = habit.collapsedMonths.indexOf(month);
            if (index > -1) {
                habit.collapsedMonths.splice(index, 1);
            } else {
                habit.collapsedMonths.push(month);
            }
            
            saveHabits();
            renderHabits();
        }

        function generateCalendar(habit) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            const today = getDateString(now);
            
            const months = currentLang === 'ru' ? MONTHS : MONTHS_EN;
            const days = currentLang === 'ru' ? DAYS : DAYS_EN;
            const weekLabel = translations[currentLang].week;
            
            // Initialize collapsedMonths if not exists
            if (!habit.collapsedMonths) {
                habit.collapsedMonths = [];
                // Auto-collapse past months
                for (let m = 0; m < currentMonth; m++) {
                    habit.collapsedMonths.push(m);
                }
                // Auto-collapse future months
                for (let m = currentMonth + 1; m < 12; m++) {
                    habit.collapsedMonths.push(m);
                }
            }
            
            let html = '<div class="calendar">';
            
            for (let month = 0; month < 12; month++) {
                const daysInMonth = getDaysInMonth(currentYear, month);
                const firstDay = getFirstDayOfMonth(currentYear, month);
                const isCollapsed = habit.collapsedMonths.includes(month);
                
                html += `<div class="month-section ${isCollapsed ? 'collapsed' : ''}">`;
                html += `<div class="month-name" onclick="toggleMonth(${habit.id}, ${month}, event)">${months[month]}</div>`;
                html += '<div class="month-content">';
                
                html += '<div class="week-grid">';
                html += '<div class="day-label"></div>';
                days.forEach(day => {
                    html += `<div class="day-label">${day}</div>`;
                });
                html += '</div>';
                
                let dayCount = 1;
                let weeks = Math.ceil((daysInMonth + firstDay) / 7);
                
                for (let week = 0; week < weeks; week++) {
                    html += '<div class="week-grid">';
                    html += `<div class="day-label">${weekLabel}${week + 1}</div>`;
                    
                    for (let day = 0; day < 7; day++) {
                        if ((week === 0 && day < firstDay) || dayCount > daysInMonth) {
                            html += '<div></div>';
                        } else {
                            const date = new Date(currentYear, month, dayCount);
                            const dateStr = getDateString(date);
                            const isCompleted = habit.completed.includes(dateStr);
                            const isToday = dateStr === today;
                            
                            html += `<div class="day-cell ${isCompleted ? 'completed' : ''} ${isToday ? 'today' : ''}" 
                                         onclick="toggleDay(${habit.id}, '${dateStr}')"
                                         title="${dayCount} ${months[month]}"
                                    ></div>`;
                            dayCount++;
                        }
                    }
                    html += '</div>';
                }
                
                // Add download button for this month
                const t = translations[currentLang];
                html += `<button class="month-download-btn" onclick="downloadHabitMonth(${habit.id}, ${month}, ${currentYear}, event)">${t.downloadMonth}</button>`;
                
                html += '</div>'; // month-content
                html += '</div>'; // month-section
            }
            
            html += '</div>';
            return html;
        }

        function calculateStats(habit) {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Total completed days across all time
            const totalDays = habit.completed.length;
            
            // Count completed days in current month only
            const thisMonthCompleted = habit.completed.filter(dateStr => {
                const date = new Date(dateStr + 'T00:00:00'); // Force local timezone
                return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
            }).length;
            
            return { totalDays, thisMonthCompleted };
        }

        function renderHabits() {
            const container = document.getElementById('habitsContainer');
            const t = translations[currentLang];
            
            const filteredHabits = habits.filter(h => {
                if (currentView === 'active') {
                    return !h.archived;
                } else {
                    return h.archived;
                }
            });
            
            if (filteredHabits.length === 0) {
                if (currentView === 'active') {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h2>${t.noActiveHabits}</h2>
                            <p>${t.noActiveHabitsDesc}</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h2>${t.emptyArchive}</h2>
                            <p>${t.emptyArchiveDesc}</p>
                        </div>
                    `;
                }
                return;
            }
            
            let html = '';
            
            filteredHabits.forEach(habit => {
                const stats = calculateStats(habit);
                const collapsedClass = habit.collapsed ? 'collapsed' : '';
                const archiveButtonText = habit.archived ? t.restore : t.toArchive;
                
                html += `
                    <div class="habit-section ${collapsedClass}">
                        <div class="habit-header" onclick="toggleCollapse(${habit.id}, event)">
                            <div class="habit-name">${habit.name}</div>
                            ${generateMiniCalendar(habit)}
                            <div class="habit-buttons">
                                <button class="archive-habit-btn" onclick="archiveHabit(${habit.id}, event)">${archiveButtonText}</button>
                                <button class="delete-btn" onclick="deleteHabit(${habit.id}, event)">${t.delete}</button>
                            </div>
                        </div>
                        <div class="calendar-container">
                            ${generateCalendar(habit)}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        document.getElementById('habitInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addHabit();
            }
        });

        document.getElementById('noteTitleInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addNote();
            }
        });

        // Telegram WebApp initialization
        let tg = window.Telegram?.WebApp;

        function initTelegramApp() {
            if (tg) {
                // Expand the app to full height
                tg.expand();
                
                // Enable closing confirmation
                tg.enableClosingConfirmation();
                
                // Set header color
                tg.setHeaderColor('secondary_bg_color');
                
                // Apply Telegram theme if available
                if (tg.themeParams) {
                    document.body.classList.add('telegram-theme');
                    
                    // Set CSS variables from Telegram theme
                    const root = document.documentElement;
                    if (tg.themeParams.bg_color) {
                        root.style.setProperty('--tg-theme-bg-color', tg.themeParams.bg_color);
                    }
                    if (tg.themeParams.text_color) {
                        root.style.setProperty('--tg-theme-text-color', tg.themeParams.text_color);
                    }
                    if (tg.themeParams.hint_color) {
                        root.style.setProperty('--tg-theme-hint-color', tg.themeParams.hint_color);
                    }
                    if (tg.themeParams.button_color) {
                        root.style.setProperty('--tg-theme-button-color', tg.themeParams.button_color);
                    }
                    if (tg.themeParams.button_text_color) {
                        root.style.setProperty('--tg-theme-button-text-color', tg.themeParams.button_text_color);
                    }
                    if (tg.themeParams.secondary_bg_color) {
                        root.style.setProperty('--tg-theme-secondary-bg-color', tg.themeParams.secondary_bg_color);
                    }
                }
                
                // Handle back button
                tg.BackButton.onClick(() => {
                    if (confirm('–í—ã–π—Ç–∏ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è?')) {
                        tg.close();
                    }
                });
                
                // Show back button when needed
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 100) {
                        tg.BackButton.show();
                    } else {
                        tg.BackButton.hide();
                    }
                });
                
                // Notify Telegram that app is ready
                tg.ready();
                
                console.log('Telegram WebApp initialized');
            }
        }

        // Initialize on load
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initTelegramApp);
        } else {
            initTelegramApp();
        }

        // Notes functions
        let saveNotesTimeout = null;
        
        function saveNotes() {
            try {
                const notesJson = JSON.stringify(notes);
                const sizeInMB = new Blob([notesJson]).size / (1024 * 1024);
                
                if (sizeInMB > 4.5) {
                    alert('–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –∑–∞–º–µ—Ç–∫–∏ –∑–∞–Ω–∏–º–∞—é—Ç –º–Ω–æ–≥–æ –º–µ—Å—Ç–∞. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–º–µ—Ç–∫–∏.');
                }
                
                localStorage.setItem('notes', notesJson);
            } catch (error) {
                if (error.name === 'QuotaExceededError') {
                    alert('–û—à–∏–±–∫–∞: –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –º–µ—Å—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è. –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–º–µ—Ç–∫–∏.');
                }
            }
        }

        function saveNotesDebounced() {
            clearTimeout(saveNotesTimeout);
            saveNotesTimeout = setTimeout(() => {
                saveNotes();
            }, 1000);
        }

        function addNote() {
            const title = document.getElementById('noteTitleInput').value.trim();
            if (!title) return;

            const newNote = {
                id: Date.now(),
                title: title,
                sections: [], // Array of {type: 'text'/'checklist', data: ...}
                archived: false,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            notes.unshift(newNote);
            saveNotes();
            renderNotes();
            document.getElementById('noteTitleInput').value = '';
            
            // Open the note for editing
            openNoteModal(newNote.id);
        }

        function archiveNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (note) {
                note.archived = true;
                saveNotes();
                renderNotes();
            }
        }

        function restoreNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (note) {
                note.archived = false;
                saveNotes();
                renderArchived();
            }
        }

        function deleteNote(noteId) {
            const t = translations[currentLang];
            if (confirm(t.deleteNoteConfirm)) {
                notes = notes.filter(n => n.id !== noteId);
                saveNotes();
                renderNotes();
                // If in archive view, update it too
                if (currentView === 'archived') {
                    renderArchived();
                }
            }
        }

        function openNoteModal(noteId) {
            currentNoteId = noteId;
            const note = notes.find(n => n.id === noteId);
            if (!note) return;

            // Migrate old format to new format
            if (!note.sections) {
                note.sections = [];
                if (note.content) {
                    note.sections.push({ type: 'text', id: Date.now(), data: note.content });
                }
                if (note.checklist && note.checklist.length > 0) {
                    note.sections.push({ type: 'checklist', id: Date.now() + 1, data: note.checklist });
                }
                delete note.content;
                delete note.checklist;
            }

            document.getElementById('noteModalTitle').value = note.title;
            document.getElementById('noteModalDate').textContent = `–ò–∑–º–µ–Ω–µ–Ω–æ: ${formatDate(note.updatedAt)}`;
            document.getElementById('noteModal').classList.add('active');

            // Render all sections
            renderNoteSections();

            // Auto-save on title input
            document.getElementById('noteModalTitle').oninput = () => saveCurrentNote();
        }

        function closeNoteModal() {
            if (currentNoteId) {
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    note.title = document.getElementById('noteModalTitle').value;
                    note.updatedAt = new Date().toISOString();
                }
            }
            
            clearTimeout(saveNotesTimeout); // Cancel any pending saves
            saveNotes(); // Save immediately
            renderNotes(); // Update the list
            
            document.getElementById('noteModal').classList.remove('active');
            currentNoteId = null;
        }

        function saveCurrentNote() {
            if (!currentNoteId) return;

            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            note.title = document.getElementById('noteModalTitle').value;
            note.updatedAt = new Date().toISOString();

            saveNotesDebounced();
            // Don't re-render on every keystroke, only save
        }

        function addTextSection() {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            const newSection = {
                type: 'text',
                id: Date.now(),
                data: ''
            };

            note.sections.push(newSection);
            saveCurrentNote();
            renderNoteSections();

            // Focus on new textarea
            setTimeout(() => {
                const textarea = document.querySelector(`[data-section-id="${newSection.id}"]`);
                if (textarea) textarea.focus();
            }, 100);
        }

        function addChecklistSection() {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            const newSection = {
                type: 'checklist',
                id: Date.now(),
                data: []
            };

            note.sections.push(newSection);
            saveCurrentNote();
            renderNoteSections();
        }

        function deleteSection(sectionId) {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            note.sections = note.sections.filter(s => s.id !== sectionId);
            saveCurrentNote();
            renderNoteSections();
        }

        function moveSectionUp(sectionId) {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            const index = note.sections.findIndex(s => s.id === sectionId);
            if (index > 0) {
                [note.sections[index], note.sections[index - 1]] = [note.sections[index - 1], note.sections[index]];
                saveCurrentNote();
                renderNoteSections();
            }
        }

        function moveSectionDown(sectionId) {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            const index = note.sections.findIndex(s => s.id === sectionId);
            if (index < note.sections.length - 1) {
                [note.sections[index], note.sections[index + 1]] = [note.sections[index + 1], note.sections[index]];
                saveCurrentNote();
                renderNoteSections();
            }
        }

        function updateTextSection(sectionId, text) {
            if (!currentNoteId) return;
            
            // Limit text to 20,000 characters
            if (text.length > 20000) {
                alert('–ú–∞–∫—Å–∏–º—É–º 20,000 —Å–∏–º–≤–æ–ª–æ–≤ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–π —Å–µ–∫—Ü–∏–∏');
                return;
            }
            
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            const section = note.sections.find(s => s.id === sectionId);
            if (section) {
                section.data = text;
                note.updatedAt = new Date().toISOString();
                saveNotesDebounced();
            }
        }

        function renderNoteSections() {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;
            
            const t = translations[currentLang];

            const container = document.getElementById('noteContentContainer');
            
            if (note.sections.length === 0) {
                const emptyText = currentLang === 'ru' 
                    ? '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –∏–ª–∏ —á–µ–∫-–ª–∏—Å—Ç'
                    : 'Click the button below to add text or checklist';
                container.innerHTML = `<div style="color: var(--text-secondary); text-align: center; padding: 40px;">${emptyText}</div>`;
                return;
            }

            let html = '';
            note.sections.forEach((section, index) => {
                html += '<div class="note-section" style="margin-bottom: 20px; padding: 15px; background: var(--input-bg); border-radius: 8px;">';
                
                // Section controls
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">';
                html += `<div style="display: flex; gap: 5px;">`;
                if (index > 0) {
                    html += `<button class="toolbar-btn" onclick="moveSectionUp(${section.id})" style="padding: 4px 8px;">‚Üë</button>`;
                }
                if (index < note.sections.length - 1) {
                    html += `<button class="toolbar-btn" onclick="moveSectionDown(${section.id})" style="padding: 4px 8px;">‚Üì</button>`;
                }
                html += `</div>`;
                html += `<button class="toolbar-btn" onclick="deleteSection(${section.id})" style="padding: 4px 8px; background: var(--delete-start); color: white;">${t.deleteSection}</button>`;
                html += '</div>';

                if (section.type === 'text') {
                    html += renderTextSection(section);
                } else if (section.type === 'checklist') {
                    html += renderChecklistSection(section);
                }
                
                html += '</div>';
            });

            container.innerHTML = html;
        }

        function renderTextSection(section) {
            const t = translations[currentLang];
            return `
                <div style="margin-bottom: 10px;">
                    <div style="display: flex; gap: 5px; margin-bottom: 8px;">
                        <button class="toolbar-btn" onclick="insertFormat(${section.id}, '**', '**')" style="padding: 4px 8px; font-size: 0.85em;">–ñ</button>
                        <button class="toolbar-btn" onclick="insertFormat(${section.id}, '*', '*')" style="padding: 4px 8px; font-size: 0.85em;">–ö</button>
                        <button class="toolbar-btn" onclick="insertFormat(${section.id}, '## ', '')" style="padding: 4px 8px; font-size: 0.85em;">–ó</button>
                        <button class="toolbar-btn" onclick="insertFormat(${section.id}, '‚Ä¢ ', '')" style="padding: 4px 8px; font-size: 0.85em;">‚Ä¢</button>
                        <span style="margin-left: auto; font-size: 0.85em; color: var(--text-secondary);">${section.data.length}/20000</span>
                    </div>
                    <textarea class="note-textarea" 
                              id="textarea-${section.id}"
                              data-section-id="${section.id}"
                              oninput="updateTextSection(${section.id}, this.value)"
                              maxlength="20000"
                              placeholder="${t.textPlaceholder}"
                              style="min-height: 150px;">${section.data}</textarea>
                </div>
            `;
        }

        function insertFormat(sectionId, before, after) {
            const textarea = document.getElementById(`textarea-${sectionId}`);
            if (!textarea) return;

            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            const newText = textarea.value.substring(0, start) + 
                           before + selectedText + after + 
                           textarea.value.substring(end);
            
            textarea.value = newText;
            textarea.focus();
            
            // Set cursor position after inserted text
            const newPos = start + before.length + selectedText.length + after.length;
            textarea.setSelectionRange(newPos, newPos);
            
            updateTextSection(sectionId, newText);
        }

        function renderChecklistSection(section) {
            let html = '<div class="checklist-container">';
            
            if (section.data.length === 0) {
                html += '<div style="color: var(--text-secondary); text-align: center; padding: 10px;">–ü—É—Å—Ç–æ</div>';
            }

            section.data.forEach(item => {
                html += `
                    <div class="checklist-item">
                        <div class="checklist-checkbox ${item.completed ? 'checked' : ''}" 
                             onclick="toggleChecklistItemInSection(${section.id}, ${item.id})"></div>
                        <input type="text" 
                               class="checklist-text ${item.completed ? 'completed' : ''}" 
                               value="${item.text}"
                               maxlength="300"
                               onchange="updateChecklistItemInSection(${section.id}, ${item.id}, this.value)"
                               onkeypress="if(event.key === 'Enter') { addChecklistItemToSection(${section.id}); event.preventDefault(); }"
                               placeholder="–¢–µ–∫—Å—Ç... (–º–∞–∫—Å 300 —Å–∏–º–≤–æ–ª–æ–≤)">
                        <span class="checklist-delete" onclick="deleteChecklistItemFromSection(${section.id}, ${item.id})">√ó</span>
                    </div>
                `;
            });

            html += `<button class="toolbar-btn" onclick="addChecklistItemToSection(${section.id})" style="width: 100%; margin-top: 10px;">+ –î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç</button>`;
            html += '</div>';
            
            return html;
        }

        // Checklist item functions for sections
        function addChecklistItemToSection(sectionId) {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            const section = note.sections.find(s => s.id === sectionId);
            if (!section || section.type !== 'checklist') return;

            const newItem = {
                id: Date.now(),
                text: '',
                completed: false
            };

            section.data.push(newItem);
            saveCurrentNote();
            renderNoteSections();

            // Focus on new item
            setTimeout(() => {
                const inputs = document.querySelectorAll('.checklist-text');
                const lastInput = inputs[inputs.length - 1];
                if (lastInput) lastInput.focus();
            }, 100);
        }

        function toggleChecklistItemInSection(sectionId, itemId) {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            const section = note.sections.find(s => s.id === sectionId);
            if (!section) return;

            const item = section.data.find(i => i.id === itemId);
            if (item) {
                item.completed = !item.completed;
                saveCurrentNote();
                renderNoteSections();
            }
        }

        function updateChecklistItemInSection(sectionId, itemId, text) {
            if (!currentNoteId) return;
            
            // Limit to 300 characters
            if (text.length > 300) {
                alert('–ú–∞–∫—Å–∏–º—É–º 300 —Å–∏–º–≤–æ–ª–æ–≤ –≤ –ø—É–Ω–∫—Ç–µ');
                return;
            }
            
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            const section = note.sections.find(s => s.id === sectionId);
            if (!section) return;

            const item = section.data.find(i => i.id === itemId);
            if (item) {
                item.text = text;
                note.updatedAt = new Date().toISOString();
                saveNotesDebounced();
            }
        }

        function deleteChecklistItemFromSection(sectionId, itemId) {
            if (!currentNoteId) return;
            
            const note = notes.find(n => n.id === currentNoteId);
            if (!note) return;

            const section = note.sections.find(s => s.id === sectionId);
            if (!section) return;

            section.data = section.data.filter(i => i.id !== itemId);
            saveCurrentNote();
            renderNoteSections();
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}`;
        }

        function renderNotes() {
            const container = document.getElementById('notesContainer');
            const t = translations[currentLang];
            
            // Show only non-archived notes
            const activeNotes = notes.filter(n => !n.archived);
            
            if (activeNotes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h2>${t.noNotes}</h2>
                        <p>${t.noNotesDesc}</p>
                    </div>
                `;
                return;
            }

            let html = '';
            activeNotes.forEach(note => {
                // Migrate old format
                if (!note.sections) {
                    note.sections = [];
                    if (note.content) {
                        note.sections.push({ type: 'text', id: Date.now(), data: note.content });
                    }
                    if (note.checklist && note.checklist.length > 0) {
                        note.sections.push({ type: 'checklist', id: Date.now() + 1, data: note.checklist });
                    }
                }

                // Generate preview
                let preview = '';
                let checklistInfo = '';
                
                note.sections.forEach(section => {
                    if (section.type === 'text' && section.data && preview.length < 150) {
                        preview += section.data.substring(0, 150 - preview.length);
                    }
                });

                // Count checklists
                const checklists = note.sections.filter(s => s.type === 'checklist');
                if (checklists.length > 0) {
                    let totalItems = 0;
                    let completedItems = 0;
                    checklists.forEach(cl => {
                        totalItems += cl.data.length;
                        completedItems += cl.data.filter(i => i.completed).length;
                    });
                    if (totalItems > 0) {
                        const checklistText = currentLang === 'ru' ? '–ß–µ–∫-–ª–∏—Å—Ç' : 'Checklist';
                        const completedText = currentLang === 'ru' ? '–≤—ã–ø–æ–ª–Ω–µ–Ω–æ' : 'completed';
                        checklistInfo = `<div style="color: var(--text-secondary); font-size: 0.9em; margin-top: 8px;">
                             ‚òëÔ∏è ${checklistText}: ${completedItems}/${totalItems} ${completedText}
                           </div>`;
                    }
                }

                const previewText = preview ? `<div class="note-preview">${preview}${preview.length >= 150 ? '...' : ''}</div>` : '';
                
                html += `
                    <div class="note-card" onclick="openNoteModal(${note.id})">
                        <div class="note-header">
                            <div class="note-title">${note.title || t.untitledNote}</div>
                            <div class="note-date">${formatDate(note.updatedAt)}</div>
                        </div>
                        ${previewText}
                        ${checklistInfo}
                        <div class="note-actions">
                            <button class="archive-habit-btn" onclick="event.stopPropagation(); archiveNote(${note.id})">${t.toArchive}</button>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteNote(${note.id})">${t.deleteNote}</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Close modal on background click
        document.getElementById('noteModal').addEventListener('click', (e) => {
            if (e.target.classList.contains('note-modal')) {
                closeNoteModal();
            }
        });

        loadHabits();
    </script>
    <!-- Note Modal -->
    <div class="note-modal" id="noteModal">
        <div class="note-modal-content">
            <div class="note-modal-header">
                <input type="text" class="note-modal-title" id="noteModalTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏...">
                <button class="note-close-btn" onclick="closeNoteModal()">√ó</button>
            </div>
            
            <div class="note-content-container" id="noteContentContainer">
                <!-- Content will be rendered here dynamically -->
            </div>
            
            <div style="display: flex; gap: 8px; margin-top: 12px;">
                <button class="toolbar-btn" id="addTextSectionBtn" onclick="addTextSection()">üìù –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
                <button class="toolbar-btn" id="addChecklistSectionBtn" onclick="addChecklistSection()">‚òëÔ∏è –î–æ–±–∞–≤–∏—Ç—å —á–µ–∫-–ª–∏—Å—Ç</button>
            </div>
            
            <div class="note-date" id="noteModalDate" style="margin-top: 12px;"></div>
        </div>
    </div>
</body>
</html>
